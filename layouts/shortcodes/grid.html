{{- $dir := .Get "dir" | default (.Get 0) | default "images" -}}
{{- $columns := .Get "columns" | default (.Get 1) | default "2" -}}
{{- $gap := .Get "gap" | default "10px" -}}
{{- $aspect := .Get "aspect" | default "square" -}}
{{- $mobileFriendly := .Get "mobile_friendly" | default false -}}
{{- $gridId := printf "grid-%s" ($dir | replaceRE "[^a-zA-Z0-9]+" "-") -}}

{{- $dirPath := printf "static/%s" $dir -}}
{{- if fileExists $dirPath -}}
<div class="square-grid-{{ $gridId }}" data-aspect="{{ $aspect }}">
  {{- $images := slice -}}
  {{- range (readDir $dirPath) -}}
    {{- if and (not .IsDir) (in (slice ".jpg" ".jpeg" ".png" ".gif" ".webp") (path.Ext .Name | lower)) -}}
      {{- $images = $images | append . -}}
    {{- end -}}
  {{- end -}}
  {{- range $index, $image := $images -}}
  <div class="grid-item">
    <img src="/{{ $dir }}/{{ $image.Name }}" alt="Image {{ $index }}" data-grid-id="{{ $gridId }}">
  </div>
  {{- end -}}
</div>

<script>
(function() {
  const grid = document.querySelector('.square-grid-{{ $gridId }}');
  const images = grid.querySelectorAll('img[data-grid-id="{{ $gridId }}"]');
  
  // Fullscreen overlay setup
  let overlay = document.querySelector('.gallery-fullscreen-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.className = 'gallery-fullscreen-overlay';
    overlay.innerHTML = '<span class="fullscreen-close">&times;</span><img src="" alt="Fullscreen image">';
    document.body.appendChild(overlay);
    
    overlay.addEventListener('click', function() {
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    });
    
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && overlay.classList.contains('active')) {
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    });
  }
  
  // Filter configuration for glitch effect
  const filters = {
    saturate: { units: '', probability: 0.2, min: 1, max: 10 },
    'hue-rotate': { units: 'deg', probability: 1, min: 0, max: 360 },
    invert: { units: '', probability: 0.033, min: 1, max: 1 },
    contrast: { units: '', probability: 0.1, min: 1, max: 10 },
    brightness: { units: '%', probability: 0.05, min: 25, max: 75 }
  };
  
  function generateGlitchFilter() {
    let filterStr = '';
    for (const [name, props] of Object.entries(filters)) {
      if (Math.random() < props.probability) {
        const value = Math.random() * (props.max - props.min) + props.min;
        filterStr += ` ${name}(${value}${props.units})`;
      }
    }
    return filterStr.trim() || 'none';
  }
  
  function generateGlitchTransform() {
    const tx = Math.random() * 10 - 5;
    const ty = Math.random() * 10 - 5;
    const scale = Math.random() * 0.05 + 1.02;
    return `translate(${tx}px, ${ty}px) scale(${scale})`;
  }
  
  images.forEach(img => {
    const item = img.closest('.grid-item');
    let isAnimating = false;
    
    img.addEventListener('click', function(e) {
      e.stopPropagation();
      if (isAnimating) return;
      
      isAnimating = true;
      const imgSrc = this.src;
      
      // Run glitch animation
      const glitchInterval = setInterval(() => {
        if (Math.random() < 0.666) {
          img.style.filter = generateGlitchFilter();
          img.style.transform = generateGlitchTransform();
        }
      }, 50);
      
      // After 200ms, stop animation and show fullscreen
      setTimeout(() => {
        clearInterval(glitchInterval);
        img.style.filter = '';
        img.style.transform = '';
        isAnimating = false;
        
        // Show fullscreen
        const overlayImg = overlay.querySelector('img');
        overlayImg.src = imgSrc;
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }, 200);
    });
  });
})();
</script>

<style>
/* Fullscreen overlay */
.gallery-fullscreen-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.95);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  cursor: zoom-out;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.gallery-fullscreen-overlay.active {
  opacity: 1;
  visibility: visible;
}

.gallery-fullscreen-overlay img {
  max-width: 95vw;
  max-height: 95vh;
  object-fit: contain;
  box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
}

.gallery-fullscreen-overlay .fullscreen-close {
  position: absolute;
  top: 20px;
  right: 30px;
  color: white;
  font-size: 40px;
  font-weight: bold;
  cursor: pointer;
  z-index: 10000;
}

.gallery-fullscreen-overlay .fullscreen-close:hover {
  color: #ccc;
}

.square-grid-{{ $gridId }} {
  display: grid;
  grid-template-columns: repeat({{ $columns }}, 1fr);
  gap: {{ $gap }};
  width: 100%;
  margin-bottom: 2rem;
}

.square-grid-{{ $gridId }}[data-aspect="square"] .grid-item {
  position: relative;
  width: 100%;
  padding-bottom: 100%;
  overflow: hidden;
  background: #f0f0f0;
  cursor: zoom-in;
}

.square-grid-{{ $gridId }}[data-aspect="square"] .grid-item img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: filter 0.05s ease, transform 0.05s ease;
}

.square-grid-{{ $gridId }}[data-aspect="original"] .grid-item {
  width: 100%;
  overflow: hidden;
  cursor: zoom-in;
}

.square-grid-{{ $gridId }}[data-aspect="original"] .grid-item img {
  width: 100%;
  height: auto;
  display: block;
  transition: filter 0.05s ease, transform 0.05s ease;
}

@media (max-width: 768px) {
  {{- if not $mobileFriendly }}
  .square-grid-{{ $gridId }} {
    grid-template-columns: repeat({{ if gt (int $columns) 2 }}2{{ else }}{{ $columns }}{{ end }}, 1fr);
  }
  {{- end }}
}

@media (max-width: 480px) {
  {{- if not $mobileFriendly }}
  .square-grid-{{ $gridId }} {
    grid-template-columns: 1fr;
  }
  {{- end }}
}
</style>
{{- end -}}
